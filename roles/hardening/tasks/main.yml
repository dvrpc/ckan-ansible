---
# tasks file for hardening
- name: Upgrade system packages
  apt:
    upgrade: true
    update_cache: true
    cache_valid_time: 86400  # one day
    autoremove: true

- name: Install system packages
  apt:
    name: fail2ban
    state: latest

- name: Allow ssh through firewall
  ufw:
    rule: allow
    name: OpenSSH
  notify: reload ufw

- name: Limit ssh connections
  ufw:
    rule: limit
    port: ssh
    proto: tcp
  notify: reload ufw

- name: Allow http through firewall
  ufw:
    rule: allow
    port: 80
    proto: tcp
  notify: reload ufw

- name: Deny all other incoming access
  ufw:
    state: enabled
    direction: incoming
    policy: deny
  notify: reload ufw

- name: Limit ssh access to ip4, disable root login, set a timeout on idle connection
  template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0644
  notify: reload sshd

- name: Configure fail2ban
  copy:
    src: jail.local
    dest: /etc/fail2ban/jail.local
    mode: 0644
  notify: restart fail2ban
